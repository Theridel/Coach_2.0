<script type="module">
    // --- PROTEZIONE CHIAVI (Promemoria Progetto) ---
    // Queste chiavi sono inserite qui solo per test immediato. 
    // TODO: Prima del deploy su Vercel, rimuoverle e usare process.env.NEXT_PUBLIC_...
    // Ricordati di inserirle nei "Secrets" di Colab con i nomi corrispondenti.
    
    const SUPABASE_URL = 'https://wrywcnpbdpdcribpirkr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyeXdjbnBiZHBkY3JpYnBpcmtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzkxODksImV4cCI6MjA4MTgxNTE4OX0.4Uu0EPIfnkBh9DaAR-SOrOwwxjTefN-GSxx8icCnENU'; // Recuperala dai Secrets di Colab

    // Inizializzazione corretta
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadAllDirectives() {
        const container = document.getElementById('dynamic-directives-container');
        
        try {
            // Unificazione tabelle: puntiamo alla tabella unica che abbiamo deciso di tenere
            const { data, error } = await _supabase
                .from('direttive_ai') // Assicurati che il nome sia corretto su Supabase
                .select('*')
                .order('id', { ascending: true });

            if (error) throw error;
            if (!data || data.length === 0) {
                container.innerHTML = '<p>Nessuna direttiva trovata. Verifica la tabella su Supabase.</p>';
                return;
            }

            container.innerHTML = ''; 

            data.forEach(item => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'directive-block';
                sectionDiv.style.marginBottom = '20px';
                
                // Usiamo l'ID univoco di Supabase per legare textarea e bottone
                sectionDiv.innerHTML = `
                    <h3>${item.sezione}</h3>
                    <textarea id="text-${item.id}" style="width:100%; min-height:100px;">${item.contenuto}</textarea>
                    <button id="btn-${item.id}">Salva ${item.sezione}</button>
                `;
                container.appendChild(sectionDiv);

                // Event listener moderno invece di onclick nell'HTML (piÃ¹ sicuro e compatibile con i moduli)
                document.getElementById(`btn-${item.id}`).addEventListener('click', () => updateDirective(item.id));
            });

        } catch (err) {
            console.error('Errore Supabase:', err.message);
            container.innerHTML = `<p style="color:red;">Errore: ${err.message}</p>`;
        }
    }

    async function updateDirective(id) {
        const nuovoContenuto = document.getElementById(`text-${id}`).value;
        const btn = document.getElementById(`btn-${id}`);
        
        btn.disabled = true;
        btn.innerText = 'Salvataggio...';

        try {
            const { error } = await _supabase
                .from('direttive_ai')
                .update({ 
                    contenuto: nuovoContenuto,
                    ultima_modifica: new Date().toISOString() 
                })
                .eq('id', id);

            if (error) throw error;
            alert('Aggiornamento completato!');
        } catch (err) {
            alert('Errore: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = `Salva`;
        }
    }

    // Avvio al caricamento
    document.addEventListener('DOMContentLoaded', loadAllDirectives);
</script>
